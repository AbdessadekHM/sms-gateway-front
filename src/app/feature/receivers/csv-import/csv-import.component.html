<div
  class="fixed inset-0 z-50 overflow-y-auto"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
>
  <div
    class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
  >
    <!-- Background overlay -->
    <div
      class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
      (click)="onCancel()"
    ></div>

    <!-- Modal panel -->
    <div
      class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
    >
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
        <div class="sm:flex sm:items-start">
          <div
            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-blue-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"
              />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3
              class="text-lg leading-6 font-medium text-gray-900"
              id="modal-title"
            >
              Import Receivers from CSV
            </h3>

            <!-- Step 1: File Upload -->
            <div *ngIf="!showPreview" class="mt-4">
              <p class="text-sm text-gray-500 mb-4">
                Upload a CSV file with the following columns: <code>name</code>,
                <code>phoneNumber</code>.
              </p>

              <div
                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"
                (dragover)="onDragOver($event)"
                (drop)="onDrop($event)"
              >
                <div class="space-y-1 text-center">
                  <svg
                    class="mx-auto h-12 w-12 text-gray-400"
                    stroke="currentColor"
                    fill="none"
                    viewBox="0 0 48 48"
                    aria-hidden="true"
                  >
                    <path
                      d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <div class="flex text-sm text-gray-600">
                    <label
                      for="file-upload"
                      class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none"
                    >
                      <span>Upload a file</span>
                      <input
                        id="file-upload"
                        name="file-upload"
                        type="file"
                        class="sr-only"
                        (change)="onFileSelected($event)"
                        accept=".csv"
                      />
                    </label>
                    <p class="pl-1">or drag and drop</p>
                  </div>
                  <p class="text-xs text-gray-500">CSV files only</p>
                </div>
              </div>

              <div *ngIf="fileName" class="mt-3 flex items-center">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-green-500 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span class="text-sm text-gray-700">{{ fileName }}</span>
                <button
                  type="button"
                  class="ml-2 text-red-500 hover:text-red-700"
                  (click)="clearFile()"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <div *ngIf="isLoading" class="mt-4 flex justify-center">
                <div
                  class="animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900"
                ></div>
              </div>
            </div>

            <!-- Step 2: Preview -->
            <div *ngIf="showPreview" class="mt-4">
              <div class="flex justify-between items-center mb-2">
                <h4 class="text-md font-medium text-gray-900">Preview</h4>
                <button
                  type="button"
                  class="text-sm text-blue-600 hover:text-blue-800"
                  (click)="clearFile()"
                >
                  Upload Another File
                </button>
              </div>

              <div class="border rounded-md p-2 mb-4">
                <div
                  class="flex justify-between text-sm font-medium text-gray-500 mb-2"
                >
                  <span>{{ preview?.totalValid || 0 }} valid records</span>
                  <span>{{ preview?.totalInvalid || 0 }} invalid records</span>
                </div>

                <!-- Valid Records -->
                <div *ngIf="preview?.valid?.length" class="mb-4">
                  <h5 class="text-sm font-medium text-green-600 mb-1">
                    Valid Records
                  </h5>
                  <div class="overflow-auto max-h-32 border rounded">
                    <table class="table-auto w-full text-sm">
                      <thead class="bg-gray-50">
                        <tr>
                          <th
                            class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                          >
                            Name
                          </th>
                          <th
                            class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                          >
                            Phone Number
                          </th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        <tr *ngFor="let receiver of preview?.valid">
                          <td class="px-3 py-2 whitespace-nowrap">
                            {{ receiver.name }}
                          </td>
                          <td class="px-3 py-2 whitespace-nowrap">
                            {{ receiver.phoneNumber }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Invalid Records -->
                <div *ngIf="preview?.invalid?.length" class="mb-2">
                  <h5 class="text-sm font-medium text-red-600 mb-1">
                    Invalid Records
                  </h5>
                  <div class="overflow-auto max-h-32 border rounded">
                    <table class="table-auto w-full text-sm">
                      <thead class="bg-gray-50">
                        <tr>
                          <th
                            class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                          >
                            Row
                          </th>
                          <th
                            class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                          >
                            Data
                          </th>
                          <th
                            class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                          >
                            Errors
                          </th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        <tr *ngFor="let invalid of preview?.invalid">
                          <td class="px-3 py-2 whitespace-nowrap">
                            {{ invalid.row }}
                          </td>
                          <td class="px-3 py-2 whitespace-nowrap">
                            {{ invalid.data.name || '-' }},
                            {{ invalid.data.phoneNumber || '-' }}
                          </td>
                          <td class="px-3 py-2">
                            <ul
                              class="list-disc list-inside text-xs text-red-500"
                            >
                              <li *ngFor="let error of invalid.errors">
                                {{ error }}
                              </li>
                            </ul>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button
          *ngIf="!showPreview"
          type="button"
          [disabled]="!file || isLoading"
          (click)="processFile()"
          class="btn btn-primary ml-3"
        >
          <span *ngIf="isLoading" class="mr-2">
            <svg
              class="animate-spin h-4 w-4 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </span>
          Preview
        </button>

        <button
          *ngIf="showPreview"
          type="button"
          [disabled]="!preview?.valid?.length || isUploading"
          (click)="importReceivers()"
          class="btn btn-primary ml-3"
        >
          <span *ngIf="isUploading" class="mr-2">
            <svg
              class="animate-spin h-4 w-4 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </span>
          Import {{ preview?.valid?.length || 0 }} Receivers
        </button>

        <button type="button" class="btn btn-ghost" (click)="onCancel()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
